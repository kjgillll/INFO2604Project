const Log = require( '../methods/log' ),
    Models = require( '../../models' ),
    Sessions = Models.sessions;

module.exports = function saveSession( request, reply ) {

    if ( !request.session || request.session._id === false )
        return reply.continue();

    if ( !request.session._id ) {

        if ( Object.keys( request.session )
            .length <= 1 )
            return reply.continue();

        request.session._id = ( ( Math.random() * 0xFFFFFFFFFFFFFF )
            .toString( 32 ) + ( Math.random() * 0xFFFFFFFFFFFFFF )
            .toString( 32 ) );

        Log.silly( 'New session', request.session._id );

    }
    reply.state( 'session', request.session._id );

    if ( request.session.user ) {

        if ( request.session.user._id )
            request.session.user = request.session.user._id;

        if ( typeof request.session.user !== 'string' )
            request.session.user = request.session.user.toString();

    } else request.session.user = undefined;

    if ( request.session.team && request.session.team._id )
        request.session.team = request.session.team._id;


    if ( request.session.isAuthenticated && !request.session.user ) {
        Log.debug( "CANNOT INSERT EMPTY USER IN SESSION" );
        return reply.continue();
    }

    Sessions.save( request.session )
        .then( () => {
            reply.continue();
        }, Log.error );

};
