const MongoDB = require( 'mongodb' ),
    Log = require( '../methods/log' ),
    FS = require( 'fs' );

const LOCAL = 'mongodb://localhost:27017/database';

let isDead = false;

// Are the env. variables set ?
var url = process.env.DATABASE || process.env.database || LOCAL;
var poolSize = process.env.POOLSIZE || 24;

try {
    url = fs.readFileSync( '/run/secrets/database' );
} catch ( e ) {}
try {
    url = fs.readFileSync( '/run/secrets/DATABASE' );
} catch ( e ) {}

let db = MongoDB.MongoClient.connect( url, {
    poolSize: poolSize
} );
db.then(
    database => Log.verbose( 'ðŸ—„  Connected to database' ),
    err => {
        if (url !== LOCAL) {
            Log.error( 'ðŸ—„  Not connected to DB', err );
            process.exit();
        } else {
            Log.warn( 'ðŸ—„  No Database configured');
            isDead = true;
        }
    }
);

module.exports = function dbConnection( collection ) {

    return new Promise( ( resolve, reject ) => {

        if (isDead) {
            Log.error('[?] DATABASE isDead');
            return resolve(false);
        }

        db.then( database => {
            if ( collection )
                resolve(database.collection( collection ));
            else
                resolve( database );
        }, (e) => {
            console.log('[?] DATABASE ERROR', e);
        } );

    } );

};
